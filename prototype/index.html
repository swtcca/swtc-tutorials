<!DOCTYPE html>
<html>
<head>
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@3.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/prismjs/themes/prism.css" />
  <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <meta charset="UTF-8">
</head>
<body>
  <div id="app">
    <v-app>
    <v-app-bar app dark>
      <v-toolbar-title>{{ settings.toolbarTitle }}</v-toolbar-title>
      <v-spacer></v-spacer>
      <v-btn color="white" @click="funcUpdateAccountInfo" text rounded class="my-2">{{ wallets.name }}</v-btn>
      <v-btn color="white" @click="browsers.dialog=!browsers.dialog" text rounded class="my-2">{{ browsers.name }}</v-btn>
      <v-btn color="white" @click="settings.dialog=!settings.dialog" text rounded class="my-2">设置</v-btn>
    </v-app-bar>

    <v-content>
      <v-container fluid>
        <v-row>
          <modal-wallet :wallets="wallets" :settings="settings" :remote="computedApiRemote"></modal-wallet>
          <modal-browser :blocks="blocks" :browsers="browsers"></modal-browser>
          <modal-settings :settings="settings"></modal-settings>

          <v-dialog v-for="card in computedFilteredCards" :key="card.key" v-model="card.raised" persistent full-page>
            <v-card min-height="500" min-width="400">
              <v-card-title class="headline">remote.{{ card.key }}({{ funcCardParam(card) }})<v-spacer></v-spacer>
                <v-btn color="red lighten-1" text @click="card.raised = false"><v-icon fab large>mdi-close-circle-outline</v-icon></v-btn>
              </v-card-title>
              <v-toolbar dense dark>
                <v-app-bar-nav-icon>
                </v-app-bar-nav-icon>
              </v-toolbar>
              <v-container>
                <v-row>
                  <v-btn fab large @click="card.showParams=!card.showParams"> 参数 </v-btn>
                </v-row>
                <v-row>
                  <v-col cols="12">
                    <v-card outlined tile :raised="card.raised">
                      <v-card-title>
                        <h2>remote.{{ card.key }}({{ funcCardParam(card) }})</h2>
                      </v-card-title>
                      <v-divider></v-divider>
                      <v-row>
                        <v-col cols="12" class="text-center" v-show="card.showParams">
                          <prism-component inline language="javascript">let remote = new Remote()</prism-component>
                        </v-col>
                        <v-col cols="12" md="6">
                          <form>
                            <v-textarea outlined auto-grow class="mt-4 pt-4" :name="card.key" label="修改代码" v-model="card.code" class="mt-2"></v-textarea>
                          </form> 
                        </v-col>
                        <v-col cols="12" md="6">
                          <prism-component language="javascript" :code="card.code"></prism-component>
                        </v-col>
                      </v-row>
                    </v-card>
                  </v-col>
                </v-row>
              </v-container>
              <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn color="green darken-1" text @click="funcEval(card.code)">运行代码</v-btn>
              </v-card-actions>
            </v-card>
          </v-dialog>
        </v-row>
	<v-flex text-center><h1>准备 概念</h1></v-flex>
        <v-row>
          <v-col cols="12" md="6" lg="4">
            <v-card :height="settings.cardHeight" outlined tile :raised="prepareBlocks.raised" @click="prepareBlocks.raised=!prepareBlocks.raised">
              <v-card-title>
                <h3>区块</h3><v-spacer></v-spacer><h3>节点</h3> 
              </v-card-title>
              <v-divider></v-divider>
              <v-row>
                <v-col cols="12" md="6">
                  <v-timeline dense>
                    <v-timeline-item v-for="(block, index) of dashboardBlocks" :key="block.id" :v-show="index < 3">
                      <v-card flat @click="block.blockDetail=!block.blockDetail">
                        <h4 class="font-weight-light">{{ block.id }}</h4>
                        <v-dialog @click="block.blockDetail=!block.blockDetail" v-model="block.blockDetail">
                          <v-card>
                            <v-card-title>
                             <v-spacer></v-spacer>
                              区块{{block.id}}内容 <v-spacer></v-spacer>
                              <v-btn color="red lighten-1" text @click="block.blockDetail=!block.blockDetail"><v-icon fab large>mdi-close-circle-outline</v-icon></v-btn>
                            </v-card-title>
                            <prism-component language="javascript">{{ block.block }}</prism-component>
                          </v-card>
                        </v-dialog>
                      </v-card>
                    </v-timeline-item>
                  </v-timeline>
                </v-col>
                <v-col cols="12" md="6">
                  <v-list-item v-for="list of prepareBlocks.lists" :key="list">
                      <v-list-item-content>
                        <v-list-item-title>{{ list }}</v-list-item-title>
                      </v-list-item-content>
                  </v-list-item>
                </v-col>
              </v-row>
            </v-card>
          </v-col>
          <v-col cols="12" md="6" lg="4">
            <v-card :height="settings.cardHeight" outlined tile :raised="prepareNode.raised" @click="prepareNode.raised=!prepareNode.raised">
              <v-card-title>
                <h3>{{ prepareNode.title }}</h3>
              </v-card-title>
              <v-divider></v-divider>
              <h3 class="pl-4">{{ prepareNode.content }}</h3>
              <v-list-item v-for="list of prepareNode.lists" :key="list">
                  <v-list-item-content>
                    <v-list-item-title>{{ list }}</v-list-item-title>
                  </v-list-item-content>
              </v-list-item>
            </v-card>
          </v-col>
          <v-col v-for="(prepare,key) in prepares" v-show="prepare.show" :key="key" cols="12" md="6" lg="4" xl="3">
            <v-card :height="settings.cardHeight" outlined tile :raised="prepare.raised" @click="funcPrepareRaise(key)">
              <v-card-title>
                <h3>{{ prepare.title }}</h3>
              </v-card-title>
              <v-divider></v-divider>
              <h3 class="pl-4">{{ prepare.content }}</h3>
              <v-list-item v-for="list of prepare.lists" :key="list">
                  <v-list-item-content>
                    <v-list-item-title>{{ list }}</v-list-item-title>
                  </v-list-item-content>
              </v-list-item>
            </v-card>
          </v-col>
        </v-row>
        <v-divider></v-divider>
	<v-container class="d-flex justify-center align-content-center"  text-center>
            <v-chip-group v-model="activeLabels" column mandatory multiple active-class="primary--text">
              <v-chip v-for="label in labels" :key="label" filter outlined large>{{ label }}</v-chip>
            </v-chip-group>
  </v-container>
        <v-divider></v-divider>
        <v-row>
          <v-col v-for="card in computedFilteredCards" :key="card.key" cols="12" md="6" lg="4">
            <v-card :height="settings.cardHeight" outlined tile :raised="card.raised" @click="funcCardRaise(card.key)">
              <v-toolbar color="indigo" dark>
                <v-toolbar-title>remote.{{ card.key }}({{ funcCardParam(card) }})</v-toolbar-title>
              </v-toolbar>
              <v-divider></v-divider>
              <v-list-item>
                <v-list-item-content>
                  <v-list-item-title>{{ card.content }}</v-list-item-title>
                </v-list-item-content>
              </v-list-item>
              <v-list-item>
                <v-list-item-content>
                  <v-list-item-title>返回 {{ card.returns }}</v-list-item-title>
                </v-list-item-content>
              </v-list-item>
              <v-list-item>
                <v-list-item-content>
                  <v-list-item-title>参数 {{ card.params }}</v-list-item-title>
                </v-list-item-content>
              </v-list-item>
            </v-card>
          </v-col>
        </v-row>
      </v-container>
    </v-content>
    <v-container>
      <vue-markdown>The time of **NOW** is :</vue-markdown>
      <vue-markdown>**Inline Math**: $\sqrt{3x-1}+(1+x)^2$</vue-markdown>
      <vue-markdown></vue-markdown>
      <vue-markdown>**Block Math**</vue-markdown>
    </v-container>  
    </v-app>
  </div>

  <script src="https://unpkg.com/prismjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
  <script src="https://unpkg.com/vue-function-api@2.2.0/dist/vue-function-api.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
  <script src="https://unpkg.com/vue-prism-component@1.1.1/dist/vue-prism-component.js"></script>
  <script src="https://unpkg.com/vue-markdown@2.2.4/dist/vue-markdown.js"></script>
  <script src="https://unpkg.com/swtc-lib"></script>
  <script src="https://unpkg.com/swtc-api"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> -->
  <script>
    Vue.use(vueFunctionApi.plugin)
    Vue.use(VueMarkdown)
    const remoteTypes = 'import { IMarker, IAmount } from "swtc-transaction"\nexport {\n  IMarker,\n  ICurrency,\n  IAmount,\n  ISwtcTxOptions,\n  IPaymentTxOptions,\n  IOfferCreateTxOptions,\n  IOfferCancelTxOptions,\n  IContractInitTxOptions,\n  IContractInvokeTxOptions,\n  IContractDeployTxOptions,\n  IContractCallTxOptions,\n  ISignTxOptions,\n  IAccountSetTxOptions,\n  IRelationTxOptions\n} from "swtc-transaction"\n\nexport interface IRemoteOptions {\n  server?: string\n  server_failover?: string\n  issuer?: string\n  token?: string\n  solidity?: boolean\n  local_sign?: boolean\n  timeout?: number\n  failover?: boolean\n}\n\nexport interface IRequestLedgerOptions {\n  ledger_index?: string | number\n  ledger_hash?: string\n  full?: boolean\n  expand?: boolean\n  transactions?: boolean\n  accounts?: boolean\n}\n\nexport interface IRequestAccountOptions {\n  account: string\n  type?: string\n  ledger?: string\n  ledger_index: string | number\n  ledger_hash: string\n  marker?: IMarker\n  peer?: any\n  limit?: string | number\n}\n\nexport interface IRequestAccountsOptions {\n  ledger_index?: string | number\n  ledger_hash?: string\n  ledger?: string\n  marker?: IMarker\n}\n\nexport interface IRequestTxOptions {\n  hash: string\n}\n\nexport interface IRequestAccountInfoOptions {\n  account: string\n  ledger?: string\n  ledger_index?: string | number\n  ledger_hash?: string\n}\n\nexport interface IRequestAccountTumsOptions {\n  account: string\n  ledger?: string\n  ledger_index?: string | number\n  ledger_hash?: string\n}\n\nexport interface IRequestAccountRelationsOptions {\n  type: string\n  account: string\n  ledger?: string\n  ledger_index?: string | number\n  ledger_hash?: string\n  limit?: string | number\n  marker?: IMarker\n}\n\nexport interface IRequestAccountOffersOptions {\n  type: string\n  account: string\n  ledger?: string\n  ledger_index?: string | number\n  ledger_hash?: string\n  limit?: string | number\n  marker?: IMarker\n}\n\nexport interface IRequestAccountTxOptions {\n  type: string\n  account: string\n  ledger?: string\n  ledger_index?: string | number\n  ledger_hash?: string\n  ledger_min?: number\n  ledger_max?: number\n  limit?: string | number\n  marker?: IMarker\n  offset?: string | number\n  forward?: boolean\n}\n\nexport interface IRequestOrderBookOptions {\n  taker?: string\n  taker_gets?: IAmount\n  taker_pays?: IAmount\n  gets?: IAmount\n  pays?: IAmount\n  limit?: string | number\n  marker?: IMarker\n}\n'.split(/\n\n/).filter( e => /export interface/.test(e))
    const txTypes = 'export interface IMarker {\n  ledger: string | number\n  seq: string | number\n}\n\nexport interface ICurrency {\n  currency: string\n  issuer: string\n}\n\nexport interface IAmount {\n  currency: string\n  issuer: string\n  value: number\n}\n\nexport interface ISwtcTxOptions {\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface IPaymentTxOptions {\n  amount: IAmount\n  source?: string\n  from?: string\n  account?: string\n  destination?: string\n  to?: string\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface IOfferCreateTxOptions {\n  type: string\n  source?: string\n  from?: string\n  account?: string\n  gets?: IAmount\n  pays?: IAmount\n  taker_gets?: IAmount\n  taker_pays?: IAmount\n  platform?: any\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface IOfferCancelTxOptions {\n  sequence: number\n  source?: string\n  from?: string\n  account?: string\n  memo?: string\n  secret?: string\n}\n\nexport interface IContractInitTxOptions {\n  amount: number\n  account: string\n  abi: any[]\n  payload: string\n  params?: string[]\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface IContractInvokeTxOptions {\n  amount: number\n  account: string\n  destination: string\n  abi: any[]\n  func: string\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface IContractDeployTxOptions {\n  amount: IAmount\n  account: string\n  payload: string\n  params?: string[]\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface IContractCallTxOptions {\n  amount: IAmount\n  account: string\n  destination: string\n  params?: string[]\n  func?: string\n  foo?: string\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface ISignTxOptions {\n  blob: string\n}\n\nexport interface IAccountSetTxOptions {\n  type: string\n  source?: string\n  from?: string\n  account?: string\n  set?: string | number\n  set_flag?: string | number\n  clear?: string | number\n  clear_flag?: string | number\n  delegate_key?: string\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n\nexport interface IRelationTxOptions {\n  type: string\n  source?: string\n  from?: string\n  account?: string\n  target: string\n  limit: IAmount\n  quality_out: any\n  quality_in: any\n  memo?: string\n  secret?: string\n  sequence?: string | number\n}\n'.split(/\n\n/).filter( e => /export interface/.test(e))
    const Remote = swtc_api.Remote
    const Wallet = Remote.Wallet

    const ModalSettings = {
      props: [ 'settings' ],
      components: { PrismComponent },
      setup(props) {
        return {
        }
      },
      template: `
          <v-dialog v-model="settings.dialog" persistent full-page>
            <v-card min-height="500" min-width="400">
              <v-card-title class="headline">设置<v-spacer></v-spacer><v-btn color="red darken-1" text @click="settings.dialog = false"><v-icon fab large>mdi-close-circle-outline</v-icon></v-btn></v-card-title>
              <v-toolbar dense dark><v-app-bar-nav-icon></v-app-bar-nav-icon></v-toolbar>
              <v-container>
                <v-row>
                  <v-col cols="6" md="4">账户地址</v-col>
                  <v-col cols="6" md="8">{{ settings.walletAddress }}</v-col>
                  <v-col cols="6" md="4">账户密钥</v-col>
                  <v-col cols="6" md="8" class="pb-4"><v-text-field label="secret" :type="settings.walletSecretEye ? 'text' : 'password'" :append-icon="settings.walletSecretEye? 'mdi-eye' : 'mdi-eye-off'" @click:append="settings.walletSecretEye=!settings.walletSecretEye" v-model="settings.walletSecret"></v-text-field></v-col>
                </v-row>
                <v-row>
                  <v-col cols="6" md="4">测试链</v-col>
                  <v-col cols="6" md="8"  class="pb-4"><v-switch v-model="settings.testChain" readonly></v-switch></v-col>
                </v-row>
                <v-row>
                  <v-col cols="6" md="4">更新间隔</v-col>
                  <v-col cols="6" md="8" class="pr-4">
                    <v-slider v-model="settings.updateInterval" class="align-center" max="20" min="5" hide-details>
                      <template v-slot:append>
                        <v-text-field v-model="settings.updateInterval" class="mt-0 pt-0" hide-details single-line type="number" style="width: 60px"></v-text-field>
                      </template>
                    </v-slider>
                  </v-col>
                </v-row>
                <v-row>
                  <v-col cols="6" md="4">最多区块</v-col>
                  <v-col cols="6" md="8" class="pr-4">
                    <v-slider v-model="settings.maxBlocks" class="align-center" max="100" min="5" hide-details>
                      <template v-slot:append>
                        <v-text-field v-model="settings.maxBlocks" class="mt-0 pt-0" hide-details single-line type="number" style="width: 60px"></v-text-field>
                      </template>
                    </v-slider>
                  </v-col>
                </v-row>
               </v-container>
            </v-card>
          </v-dialog>
        `
    }
    const ModalWallet = {
      props: [ 'wallets', 'remote', 'settings' ],
      components: { PrismComponent },
      setup(props) {
        const funcUpdateAccountInfo = async () => {
            console.log(`...updating balance for ${props.settings.walletAddress}`)
            props.wallets.dialog = true
            props.remote.getAccountBalances(props.settings.walletAddress).then(result => props.wallets.accountInfo.balances = result).catch(() => {})
            props.remote.getAccountPayments(props.settings.walletAddress).then(result => props.wallets.accountInfo.payments = result).catch(() => {})
            props.remote.getAccountOrders(props.settings.walletAddress).then(result => props.wallets.accountInfo.orders = result).catch(() => {})
            props.remote.getAccountTransactions(props.settings.walletAddress).then(result => props.wallets.accountInfo.txs = result).catch(() => {})
          }
        return {
          funcUpdateAccountInfo
        }
      },
      template: `
          <v-dialog v-model="wallets.dialog" persistent full-page>
            <v-card min-height="500" min-width="400">
              <v-card-title class="headline">账户<v-spacer></v-spacer>
                <v-btn color="red lighten-1" text @click="funcUpdateAccountInfo"><v-icon fab large>mdi-reload</v-icon></v-btn>
                <v-btn color="red lighten-1" text @click="wallets.dialog=false"><v-icon fab large>mdi-close-circle-outline</v-icon></v-btn>
              </v-card-title>
              <v-toolbar dense dark><v-app-bar-nav-icon></v-app-bar-nav-icon></v-toolbar>
              <v-container>
                <v-row>
                  <v-tabs v-model="wallets.accountTabs">
                    <v-tabs-slider></v-tabs-slider>
                    <v-tab v-for="(v, name) in wallets.accountInfo" :key="name" :href="'#' + name">{{ name }}</v-tab>
                  </v-tabs>
                </v-row>
                <v-row>
                  <v-tabs-items v-model="wallets.accountTabs">
                      <v-tab-item v-for="(v, name) in wallets.accountInfo" :key="name" :value="name">
                          <prism-component language="javascript">
{{v}}</prism-component>
                      </v-tab-item>
                  </v-tabs-items>
                </v-row>
              </v-container>
            </v-card>
          </v-dialog>
        `
    }
    const ModalBrowser = {
      props: [ 'browsers', 'blocks' ],
      components: { PrismComponent },
      setup(props) {
        return {
        }
      },
      template: `
          <v-dialog v-model="browsers.dialog" persistent full-page>
            <v-card min-height="500" min-width="400">
              <v-card-title class="headline">浏览器<v-spacer></v-spacer><v-btn color="red lighten-1" text @click="browsers.dialog=false"><v-icon fab large>mdi-close-circle-outline</v-icon></v-btn></v-card-title>
              <v-toolbar dense dark><v-app-bar-nav-icon></v-app-bar-nav-icon></v-toolbar>
              <v-timeline dense>
                <v-timeline-item v-for="block of blocks" :key="block.id">
                    <v-card>
                    <v-card-title class="purple lighten-2" @click="block.blockDetail=!block.blockDetail">
                        <h4 class="white--text font-weight-light">{{ block.id }}</h4>
                    </v-card-title>
                    <v-container>
                      <v-treeview :items="[block]" item-children="transactions"></v-treeview>
                      <prism-component v-show="block.blockDetail" language="javascript">{{ block.block }}</prism-component>
                    </v-container>
                  </v-card>
                </v-timeline-item>
              </v-timeline>
            </v-card>
          </v-dialog>
        `
    }
    const vm = new Vue({
      el: '#app',
      vuetify: new Vuetify(),
      components: { PrismComponent, ModalBrowser, ModalWallet, ModalSettings },
      setup() {
        const ledger = vueFunctionApi.value(0)
        const started = vueFunctionApi.value(false)
        const interval = vueFunctionApi.value(null)
        const settings = vueFunctionApi.value({
            dialog: false,
            toolbarTitle: 'SWTCLIB 教程',
            testChain: localStorage.testChain || true,
            walletSecret: localStorage.walletSecret || '',
            walletSecretEye: localStorage.walletSecretEye || true,
            walletAddress: localStorage.walletAddress || '',
            updateInterval: 10,
            maxBlocks: 10,
            cardHeight: localStorage.cardHeight || 270,
            libServer: localStorage.libServer || 'ws://ts5.jingtum.com:5020',
            apiServer: localStorage.apiServer || 'https://tapi.jingtum.com',
            testIssuer:localStorage.testIssuer || 'jBciDE8Q3uJjf111VeiUNM775AMKHEbBLS',
          })
        const evalString = vueFunctionApi.value('// node.js需要导入库 swtc_lib = require("swtc-lib")')
        const labels = vueFunctionApi.value([ '基础', '查询', '写入', '进阶', '辅助', '独有', '合约', '买卖', '未知' ])
        const activeLabels = vueFunctionApi.value([1])
        const wallets = vueFunctionApi.value({
            accountInfo: {balances: {loading: true}, payments: {loading: true}, orders: {loading: true}, txs: {loading: true}},
            accountTabs: 'balances',
            id: 'account',
            name: '账户',
            dialog: false
          })
        const browsers = vueFunctionApi.value({id: 'browser', name: '浏览器', dialog: false})
        const blocks = vueFunctionApi.value([])
        const dashboardBlocks = vueFunctionApi.value([])
        const funcEval = (string) => {
          string = `try {
${string}
} catch (error) {
  console.log(error)
  alert('运行出错了，修改检查')
}
`
          eval(string)
        }
        const funcSetInterval = () => {
            let remote = computedApiRemote.value
            interval.value = setInterval(async () => {
                if (started.value) {
                  try {
                    let block = await remote.getLedger(ledger.value + 1)
                    if (block.closed) {
                      ledger.value = ledger.value + 1
                      if (!blocks.value.find(e => e.id === block.ledger_index)) {
                        blocks.value.unshift({id: block.ledger_index, name: block.ledger_hash, blockDetail: false, transactions: block.transactions.map( (e,i) => ({id: i, name: e})), block})
                        dashboardBlocks.value.unshift({id: block.ledger_index, name: block.ledger_hash, blockDetail: false, transactions: block.transactions.map( (e,i) => ({id: i, name: e})), block})
                        blocks.value.splice(settings.value.maxBlocks)
                        dashboardBlocks.value.splice(3)
                      }
                    } else {
                      console.log(`...ledger ${ledger.value + 1} not closed yet`)
                    }
                  } catch (error) {
                    console.log(error)
                    console.log('wait for next')
                  }
                } else {
                  console.log('not started yet')
                }
              }, settings.value.updateInterval * 1000)
        }
        const funcClearInterval = () => {
          if (interval.value) {
            clearInterval(interval.value)
          }
        }
        const funcPrepareRaise = (key) => {
            computedPrepareKeys.value.forEach(
              e => e === key ? (prepares.value)[e].raised = true : (prepares.value)[e].raised = false
            )
          }
        const funcCardRaise = (key) => {
            computedCardKeys.value.forEach(
              e => e === key ? (cards.value)[e].raised = true : (cards.value)[e].raised = false
            )
          }
        const funcCardParam = (card) => {
            let r = ''
            if (card.params) {
              r = `{}`
            }
            return r
          }
        // const funcMarked = (text) => marked(text)
        const funcUpdateAccountInfo = async () => {
            wallets.value.dialog = true
            let remote = computedApiRemote.value
            remote.getAccountBalances(settings.value.walletAddress).then(result => wallets.value.accountInfo.balances = result).catch(error => wallets.value.accountInfo.balances = {error: '未激活'})
            remote.getAccountPayments(settings.value.walletAddress).then(result => wallets.value.accountInfo.payments = result).catch(error => wallets.value.accountInfo.balances = {error: '未激活'})
            remote.getAccountOrders(settings.value.walletAddress).then(result => wallets.value.accountInfo.orders = result).catch(error => wallets.value.accountInfo.balances = {error: '未激活'})
            remote.getAccountTransactions(settings.value.walletAddress).then(result => wallets.value.accountInfo.txs = result).catch(error => wallets.value.accountInfo.balances = {error: '未激活'})
          }
        vueFunctionApi.watch(activeLabels, (value, oldValue) => {
            console.log(value)
              computedPrepareKeys.value.forEach(key => {
                let prepare = prepares.value[key]
                console.log("got prepare " + prepare.key)
                prepare.show = false
                value.forEach(label_index => {
                  let label = labels.value[label_index]
                  if (prepare.labels.indexOf(label) !== -1) {
                    prepare.show = true
                  }
                })
              })
          }, {lazy: true})
        vueFunctionApi.watch(() => settings.value.walletSecret, (value, oldValue) => { if (Wallet.isValidSecret(value)) { localStorage.walletSecret = value; settings.value.walletAddress = Wallet.fromSecret(value).address; localStorage.walletAddress = settings.value.walletAddress }}, {lazy: true})
        vueFunctionApi.watch(() => settings.value.testChain, (value, oldValue) => {
            console.log(`detected change from ${oldValue} to ${value}` )
            funcClearInterval()
            funcSetInterval()
          }, {lazy: true})
        const computedPrepareKeys = vueFunctionApi.computed(() => Object.keys(prepares.value))
        const computedCardKeys = vueFunctionApi.computed(() => Object.keys(cards.value))
        vueFunctionApi.onCreated(async () => {
            console.log("...vue created")
            console.log(remoteTypes)
            console.log(txTypes)
            if (!settings.value.walletSecret || !Wallet.isValidSecret(settings.value.walletSecret)) {
              // generate a wallet
              let wallet = Wallet.generate()
              settings.value.walletSecret = wallet.secret
              settings.value.walletAddress = wallet.address
              localStorage.walletSecret = wallet.secret
              localStorage.walletAddress = wallet.address
            }
            if (settings.value.testChain) {
              evalString.value += `\nlet remote = new swtc_lib.Remote(
    {
      server: "${settings.value.libServer}",
      // issuer: "${settings.value.testIssuer}"
    }
  )
`
            } else {
              evalString.value += `\nlet remote = new swtc_lib.Remote()`
            }
            evalString.value += `\nconsole.dir(remote.config())`
            evalString.value += `\n// 如果没有javascript终端 alert(JSON.stringify(remote.config(), '', 2))`
            let remote = computedApiRemote.value
            if (Wallet.isValidSecret(settings.value.walletSecret)) {
              settings.value.walletAddress = Wallet.fromSecret(settings.value.walletSecret).address
              localStorage.walletAddress = settings.value.walletAddress
            } else {
              settings.value.walletAddress = 'secret incorrect 密钥错误'
              localStorage.walletAddress = settings.value.walletAddress
              localStorage.walletSecret = ''
            }
            try {
              let block = await remote.getLedger()
              ledger.value = block.ledger_index
              started.value = true
              //console.log('block explorer initiated')
              block = await remote.getLedger(ledger.value)
              
              blocks.value.unshift({id: block.ledger_index, name: block.ledger_hash, blockDetail: true, transactions: block.transactions.map( (e,i) => ({id: i, name: e})), block})
              dashboardBlocks.value.unshift({id: block.ledger_index, name: block.ledger_hash, blockDetail: false, transactions: block.transactions.map( (e,i) => ({id: i, name: e})), block})
            } catch (error) {
              console.log(error)
            }
          })
        vueFunctionApi.onMounted(() => {
            // console.log("...vue mounted")
            funcInitCards()
            funcSetInterval()
          })
        const computedRemoteOption = vueFunctionApi.computed(() => {
            return settings.value.testChain ? {server: 'ws://ts5.jingtum.com:5020', issuer: settings.value.testIssuer} : {}
          })
        const computedApiRemoteOption = vueFunctionApi.computed(() => {
            return settings.value.testChain ? {server: 'https://tapi.jingtum.com', issuer: settings.value.testIssuer} : {}
          })
        const computedRemoteString = vueFunctionApi.computed(() => {
            let r
            if (settings.value.testChain) {
              r = `new (swtc_lib.Remote)({server: 'ws://ts5.jingtum.com:5020'})`
            } else if (settings.value.libServer) {
              r = `new (swtc_lib.Remote)({server: settings.value.libServer})`
            } else {
              r = `new (swtc_lib.Remote)()`
            }
            return r
          })
        const computedRemote = vueFunctionApi.computed(() => {
            let r
            if (settings.value.testChain) {
              r = new (swtc_lib.Remote)({server: 'ws://ts5.jingtum.com:5020', issuer: settings.value.testIssuer})
            } else if (settings.value.libServer) {
              r = new (swtc_lib.Remote)({server: settings.value.libServer})
            } else {
              r = new (swtc_lib.Remote)()
            }
            return r
          })
        const computedApiRemote = vueFunctionApi.computed(() => {
            let r
            if (settings.value.testChain) {
              r = new (swtc_api.Remote)({server: 'https://tapi.jingtum.com', issuer: settings.value.testIssuer})
            } else if (settings.value.apiServer) {
              r = new (swtc_api.Remote)({server: settings.value.apiServer})
            } else {
              r = new (swtc_api.Remote)()
            }
            return r
          })
        const funcInitCards = () => {
            computedCardKeys.value.forEach((key) => {
              let card = cards.value[key]
              console.log(`processing card for ${key}`)
              if (key.startsWith('request')) {
                card.labels.push('查询')
              }
              if (key.startsWith('build')) {
                card.labels.push('写入')
              }
              if (key.match(/contract/i)) {
                card.labels.push('合约')
              }
              if (key.match(/offer/i)) {
                card.labels.push('买卖')
              }
              card.code = `
// node.js 环境需要导入库 swtc_lib = require("swtc-lib")

let remote = ${computedRemoteString.value}
remote.connectPromise()
  .then(async (result) => {
      console.log(result)
      // 试验场所
      result = await remote.${key}(${funcCardParam(card)}).submitPromise()
      console.dir(result)
      // alert(JSON.stringify(result, '', 2))
      remote.disconnect()
    })
  .catch((error) => console.error(error))
`
            })
          }
        const prepareBlocks = vueFunctionApi.value({
            title: '区块|井通节点',
            content: '区块|井通节点',
            lists: [
              '区块链数据 - 全账本',
              '区块链数据 - 部分账本',
              'websocket - 交互接口',
              'websocket - 查询写入',
            ]
          })
        const prepareNode = vueFunctionApi.value({
            title: 'SWTCLIB库',
            content: '引用SWTCLIB',
            lists: [
              "node.js - swtc_lib = require('swtc-lib')",
              'web - <script src="https://unpkg.com/swtc-lib" />',
            ]
          })
        const prepares = vueFunctionApi.value({
          swtclib: {
            key: 'swtclib',
            show: true,
            labels: ["基础"],
            title: '包装类 - Remote',
            content: 'swtc_lib.Remote',
            lists: [
              '创建 实例 - remote = new Remote()',
              '请求 查询 - request = remote.request***()',
              '请求 写入 - tx = remote.build***Tx()'
            ]
          },
          request: {
            key: 'request',
            show: false,
            labels: ["基础"],
            title: '包装类 - Request [查询]',
            content: 'swtc_lib.Request',
            lists: [
              '实例 - request = new Request()',
              '提交promise - request.submitPromise()',
            ]
          },
          tx: {
            key: 'tx',
            show: false,
            labels: ["基础"],
            title: '包装类 - Transaction [写入]',
            content: 'swtc_lib.Transaction',
            lists: [
              '实例 - tx = new Transaction()',
              '提交promise - tx.submitPromise(secret)',
            ]
          },
          wallet: {
            key: 'wallet',
            show: false,
            labels: ["基础"],
            title: '包装类 - Wallet [账户]',
            content: 'swtc_lib.Wallet',
            lists: [
              '实例 - wallet = new Wallet(secret)',
              '静态方法 - w1 = Wallet.generate()',
              '静态方法 - w2 = Wallet.fromSecret(secret)',
            ]
          },
        })
        const computedFilteredCards = vueFunctionApi.computed(() => {
            let filteredSet = new Set()
            activeLabels.value.forEach(label_index => {
              let label = labels.value[label_index]
              computedCardKeys.value.forEach(key => {
                card = cards.value[key]
                if (card.labels.indexOf(label) !== -1) {
                  filteredSet.add(card)
                }
              })
            })
            let filtered = []
            filteredSet.forEach(card => filtered.push(card))
            return filtered
          })
        const cards = vueFunctionApi.value({
          requestServerInfo: {
            key: 'requestServerInfo',
            title: '查询服务器信息',
            content: '查询服务器信息',
            code: '',
            params: '',
            showParams: false,
            returns: 'request',
            labels: ['基础'],
            raised: false
          },
          requestLedgerClosed: {
            key: 'requestLedgerClosed',
            title: '查询最新关闭的区块',
            content: '查询最新关闭的区块',
            code: '',
            params: '',
            showParams: false,
            returns: 'request',
            labels: ['基础'],
            raised: false
          },
          requestLedger: {
            key: 'requestLedger',
            title: '查询区块',
            content: '查询区块',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: ['基础'],
            raised: false
          },
          requestTx: {
            key: 'requestTx',
            title: '查询交易信息',
            content: '查询交易信息',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: [],
            raised: false
          },
          requestPathFind: {
            key: 'requestPathFind',
            title: '查询路径撮合',
            content: '查询路径撮合',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: ["进阶"],
            raised: false
          },
          requestAccountInfo: {
            key: 'requestAccountInfo',
            title: '查询账户信息',
            content: '查询账户信息',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: ['基础'],
            raised: false
          },
          requestAccountOffers: {
            key: 'requestAccountOffers',
            title: '查询账户挂单',
            content: '查询账户挂单',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: [],
            raised: false
          },
          requestAccountTx: {
            key: 'requestAccountTx',
            title: '查询账户记录',
            content: '查询账户记录',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: ['基础'],
            raised: false
          },
          requestOrderBook: {
            key: 'requestOrderBook',
            title: '查询挂单列表',
            content: '查询挂单列表',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: [],
            raised: false
          },
          requestAccountTums: {
            key: 'requestAccountTums',
            title: '查询账户通证',
            content: '查询账户通证',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'request',
            labels: ['基础'],
            raised: false
          },
          buildAccountSetTx: {
            key: 'buildAccountSetTx',
            title: '创建账户关系交易',
            content: '创建账户关系交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: [],
            raised: false
          },
          buildBrokerageTx: {
            key: 'buildBrokerageTx',
            title: '创建代理商交易',
            content: '创建代理商交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: ["进阶"],
            raised: false
          },
          buildContractCallTx: {
            key: 'buildContractCallTx',
            title: '创建执行LUA合约交易',
            content: '创建执行LUA合约交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: [],
            raised: false
          },
          buildContractDeployTx: {
            key: 'buildContractDeployTx',
            title: '创建部署LUA合约交易',
            content: '创建部署LUA合约交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: [],
            raised: false
          },
          buildContractInitTx: {
            key: 'buildContractInitTx',
            title: '创建部署SOLIDITY合约交易',
            content: '创建部署SOLIDITY合约交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: [],
            raised: false
          },
          buildContractInvokeTx: {
            key: 'buildContractInvokeTx',
            title: '创建执行SOLIDITY合约交易',
            content: '创建执行SOLIDITY合约交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: [],
            raised: false
          },
          buildOfferCancelTx: {
            key: 'buildOfferCancelTx',
            title: '创建取消挂单交易',
            content: '创建取消挂单交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: [],
            raised: false
          },
          buildOfferCreateTx: {
            key: 'buildOfferCreateTx',
            title: '创建提交挂单交易',
            content: '创建提交挂单交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: [],
            raised: false
          },
          buildPaymentTx: {
            key: 'buildPaymentTx',
            title: '创建支付交易',
            content: '创建支付交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: ["基础"],
            raised: false
          },
          buildRelationTx: {
            key: 'buildRelationTx',
            title: '创建关系交易',
            content: '创建关系交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: ["进阶"],
            raised: false
          },
         // _setSequecePromise: {
         //   key: 'setSequencePromise',
         //   title: '设置交易序号',
         //   content: '设置交易序号',
         //   code: '',
         //   params: '[sequence]',
         //   showParams: false,
         //   returns: 'tx',
         //   labels: ["进阶"],
         //   raised: false
         // },
         // signPromise: {
         //   key: 'signPromise',
         //   title: '签名交易',
         //   content: '签名交易',
         //   code: '',
         //   params: 'secret [memo [sequence]]',
         //   showParams: false,
         //   returns: 'blob',
         //   labels: ["进阶"],
         //   raised: false
         // },
          buildSignTx: {
            key: 'buildSignTx',
            title: '创建签名交易',
            content: '创建签名交易',
            code: '',
            params: 'object',
            showParams: false,
            returns: 'tx',
            labels: ["未知"],
            raised: false
          }
        })
        return {
          settings,
          labels,
          activeLabels,
          wallets,
          browsers,
          interval,
          evalString,
          ledger,
          started,
          blocks,
          dashboardBlocks,
          computedFilteredCards,
          cards,
          prepareBlocks,
          prepareNode,
          prepares,
          computedPrepareKeys,
          computedCardKeys,
          computedRemoteOption,
          computedApiRemoteOption,
          computedRemote,
          computedRemoteString,
          computedApiRemote,
          funcPrepareRaise,
          funcCardRaise,
          funcCardParam,
          funcInitCards,
          funcEval,
          funcSetInterval,
          funcClearInterval,
          funcUpdateAccountInfo
        }
      }
    })
    if (window) { window.vm = vm}
  </script>
</body>
</html>
